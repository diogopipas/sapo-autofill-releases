name: Mirror Private Release

on:
  repository_dispatch:
    types: [private-release]   # <- choose “Repository dispatch” trigger in the UI

permissions:
  contents: write   # allows gh release create/delete to succeed

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (optional if you don’t modify files)
        uses: actions/checkout@v4

      - name: Download assets from private repo
        env:
          PRIVATE_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}  # PAT with repo scope to access private repo
        run: |
          mkdir artifacts
          echo '${{ toJson(github.event.client_payload.assets) }}' | jq -c '.[]' | while read asset; do
            NAME=$(echo "$asset" | jq -r '.name')
            URL=$(echo "$asset" | jq -r '.url')
            curl -sSL -H "Accept: application/octet-stream" \
                       -H "Authorization: Bearer ${PRIVATE_TOKEN}" \
                       "$URL" -o "artifacts/$NAME"
          done

      - name: Publish release in public repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract version from artifact filename or use date-based version
          VERSION=$(date +"%Y.%m.%d")
          TAG="v$VERSION"
          TITLE="SAPO Emprego Autofill v$VERSION"
          NOTES=''
          
          # Delete existing release if it exists (ignore errors)
          gh release delete "$TAG" --yes || true
          
          # Check if artifacts exist
          if [ -d "artifacts" ] && [ "$(ls -A artifacts 2>/dev/null)" ]; then
            # Create release with artifacts
            gh release create "$TAG" artifacts/* \
              --title "$TITLE" \
              --notes "$NOTES" \
              --latest
          else
            # Create release without artifacts
            gh release create "$TAG" \
              --title "$TITLE" \
              --notes "$NOTES" \
              --latest
          fi
