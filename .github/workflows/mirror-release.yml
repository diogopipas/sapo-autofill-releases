name: Mirror Private Release

on:
  repository_dispatch:
    types: [private-release]

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Download assets from private repo
        env:
          PRIVATE_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p dist

          echo '${{ toJson(github.event.client_payload.assets) }}' | jq -c '.[]' | while read asset; do
            NAME=$(echo "$asset" | jq -r '.name')
            URL=$(echo "$asset" | jq -r '.api_url')
            EXPECTED_SIZE=$(echo "$asset" | jq -r '.size')

            curl --fail --location \
                 -H "Accept: application/octet-stream" \
                 -H "Authorization: Bearer ${PRIVATE_TOKEN}" \
                 "$URL" -o "dist/$NAME"

            ACTUAL_SIZE=$(stat -c%s "dist/$NAME" 2>/dev/null || stat -f%z "dist/$NAME")
            if [ "$ACTUAL_SIZE" -ne "$EXPECTED_SIZE" ]; then
              echo "âŒ Downloaded size ($ACTUAL_SIZE) differs from expected ($EXPECTED_SIZE) for $NAME" >&2
              exit 1
            fi
          done

      - name: Publish release in public repo
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_RELEASES_TOKEN }}
        run: |
          set -euo pipefail

          VERSION="${{ github.event.client_payload.tag }}"
          VERSION="${VERSION#v}"
          TAG="v$VERSION"
          TITLE="${{ github.event.client_payload.release_name }}"
          NOTES=${{ toJson(github.event.client_payload.notes) }}

          gh release delete "$TAG" --cleanup-tag --yes >/dev/null 2>&1 || true

          gh release create "$TAG" dist/* \
            --title "$TITLE" \
            --notes "$NOTES" \
            --latest
